-- DROP FUNCTION IF EXISTS listar_zonas();

CREATE OR REPLACE FUNCTION listar_zonas()
RETURNS TABLE(
    zona TEXT,
    total BIGINT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        UPPER(TRIM(
            CASE 
                WHEN POSITION(',' IN p.zona) > 0 THEN SUBSTRING(p.zona FROM 1 FOR POSITION(',' IN p.zona) - 1)
                ELSE p.zona
            END
        )) AS zona,
        COUNT(*) AS total
    FROM public.pedidos p
    WHERE p.zona IS NOT NULL
    GROUP BY UPPER(TRIM(
            CASE 
                WHEN POSITION(',' IN p.zona) > 0 THEN SUBSTRING(p.zona FROM 1 FOR POSITION(',' IN p.zona) - 1)
                ELSE p.zona
            END
        ))
    ORDER BY total DESC;
END;
$$ LANGUAGE plpgsql;